_base:
    summary: A benchmarking tool designed to maintain constant per-task I/o workload as task count is varied.
    variables:
        #problem: 
         #   - { name: "macsio", np: '{{$n}}', interface: '{{$i}}', parallelFmode: '{{$m}}', partType: '{{$pt}}', partDim: '{{$pd}}', partSize: '{{$ps}}',  flags: '-macsio' }
          #  - { name: "macsioWsilo", np: '$n', interface: '$i', parallelFmode: '$m', pxval: '4', pyval: '3', flags: '-macsioWsilo' }
           # - { name: "macsioWsiloWhdf5", np: '$n', interface: '$i', parallelFmode: '$m', flags: '-macsioWsiloWhdf5'  }
          numOfTasks: 93
          numOfHDF5: 8
          mode: MIF
          partDim: 2
          partType: rectilinear
          ppTask: 3
          ppSize: 40000


    slurm:
        #can run on multiple nodes
          num_nodes: 3
   
_build:
    #not used in the build but run section inherits_from: _base
    build:
        modules: [cmake, gcc, openmpi/2.1.2, hdf5-parallel]
        source_path: macsio
        env:
            CC: mpicc
            JSONCWX_PREFIX: $PWD/JSONCWX
            SILO_PREFIX: $PWD/SILO
            MACSIO_PREFIX: $PWD/MACSIO
        cmds:
            #Getting the files for json-cwx,hdf5 and silo
            #- git clone https://github.com/LLNL/json-cwx.git
            #SILO requires a patch to work properly
            #- wget https://wci.llnl.gov/content/assets/docs/simulation/computer-codes/silo/silo-4.10.2/silo-4.10.2.tar.gz

            #Getting Patched MACSio-1.1
            #- wget https://github.com/LLNL/MACSio/archive/v1.1.tar.gz
            
            #Extracting files
            - tar xfz ./json-cwx.tgz

            #Make Json-cwx
            - cd ./json-cwx/json-cwx
            - sh autogen.sh
            - ./configure --prefix=$JSONCWX_PREFIX
            - make -j
            - make install
            - cd ../..

            #Make silo
            - tar xfz silo-4.10.2.tar.gz
            - cd silo-4.10.2
            - ./configure CFLAGS="-I$HDF5_ROOT/include $CFLAGS" LDFLAGS="-L$HDF5_ROOT/lib $LDFLAGS" CXX=mpicxx CC=mpicc FC=mpif90
              --prefix=$SILO_PREFIX --with-hdf5=${HDF5_ROOT} --enable-shared --enable-install-lite-headers --enable-fortran
            - make -j
            - make install
            - cd ../
            
            
            #Build MACSio with Silo and HDF5 plugins
            - tar xfz MACSio.tgz
            - cd MACSio
            - git checkout v1.1
            - cmake -DCMAKE_INSTALL_PREFIX=$MACSIO_PREFIX -DWITH_JSON-CWX_PREFIX=$JSONCWX_PREFIX -DWITH_SILO_PREFIX=$SILO_PREFIX -DENABLE_HDF5_PLUGIN=ON -DWITH_HDF5_PREFIX=$HDF5_ROOT .
            - make
            - make install

#Test for running MACSio with out plugins
macsio:
    inherits_from: _build
    summary: MACSio test with out plug-ins
    run:
        modules: 
            - gcc
            - openmpi
            - "hdf5-parallel/1.8.16"
        cmds:
            - export LD_LIBRARY_PATH=$PWD/JSONCWX:$LD_LIBRARY_PATH
            - export LD_LIBRARY_PATH=$PWD/SILO:$LD_LIBRARY_PATH
            - srun -n4 $PWD/MACSIO/macsio --interface silo    
            - srun -n4 $PWD/MACSIO/macsio --interface hdf5    
            - srun -n4 $PWD/MACSIO/macsio --interface miftmpl    
   # result_parse:
  #      regex:
  #          #resultOrSomeName:
  #              regex:
 #               action:

#Test for running MACSio using Silo plugin
#macsioWsilo:
   # inherits_from: _build
   # summary: MACSio test with plug-in Silo enabled
   # run:
   #     cmds:
   # result_parse:
       # regex:
            #variableOrSomeName:
         #       regex:
        #        action:

#Test for running MACSio using Silo plugin with HDF5 enabled
macsioWsiloHDF5:
    inherits_from: _build
    summary: MACSio test with plug-in Silo and HDF5 enabled
    run:
        cmds:
            - echo "Running 93 tasks to 8 HDF5 files in Multiple Independent File Mode."
            - srun -np 93 ./macsio --interface hdf5 --parallel_file_mode MIF 8

            - echo "Running 93 tasks to 1 HDF5 file in Single Shared File Mode."
            - srun - np 93 ./macsio --interface hdf5 --parallel_file_mode SIF 1

            #- echo "Running {{numOfTasksVariable}} tasks to {{numOfHDF5fileVariable}} HDF5 files in {{modeVariable}}."
            #- srun -np {{numOfTasksVariable}} ./macsio --interface hdf5 --parallel_file_mode {{modeVariable}} {{numOfHDF5fileVariable}}
            #
            #- echo "Running {{numOfTasks}} tasks to {{numOfHDF5}} HDF5 files in {{mode}},on a {{partDim}} dimensional, {{partType}} mesh with {{ppTask}} average parts per task and a nominal I/O request of{{ppSize}} bytes"
            #- srun -np {{numOfTasks}} ./macsio --interface hdf5 --parallel_file_mode {{mode}} {{numofHDF5}} --avg_num_parts {{ppTask}} --part_size {{ppSize}} --part_dim {{partDim}} --part_type {{partType}}
            #  
            #
    #result_parse:
     #   regex:
            #KeywordOrSomeName:
      #          regex:
       #         action: 
